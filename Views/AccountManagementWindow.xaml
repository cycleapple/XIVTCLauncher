<Window x:Class="FFXIVSimpleLauncher.Views.AccountManagementWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="帳號管理"
        Height="550" Width="480"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Medium"
        FontFamily="{materialDesign:MaterialDesignFont}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16">
            <materialDesign:PackIcon Kind="AccountMultiple"
                                     Width="28" Height="28"
                                     VerticalAlignment="Center"
                                     Foreground="{DynamicResource PrimaryHueMidBrush}"/>
            <TextBlock Text="帳號管理"
                       Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                       VerticalAlignment="Center"
                       Margin="8,0,0,0"/>
        </StackPanel>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Account List -->
            <materialDesign:Card Grid.Column="0" Padding="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Button Grid.Row="0"
                            Content="+ 新增帳號"
                            Command="{Binding AddAccountCommand}"
                            Style="{StaticResource MaterialDesignFlatButton}"
                            HorizontalAlignment="Stretch"
                            Margin="0,0,0,8"/>

                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding Accounts}"
                             SelectedItem="{Binding SelectedAccount}"
                             Style="{StaticResource MaterialDesignListBox}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="4">
                                    <TextBlock Text="{Binding DisplayName}"
                                               FontWeight="Bold"
                                               FontSize="14"/>
                                    <TextBlock Text="{Binding Username}"
                                               Foreground="Gray"
                                               FontSize="11"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </materialDesign:Card>

            <!-- Separator -->
            <GridSplitter Grid.Column="1" Width="16" Background="Transparent"/>

            <!-- Account Details / Edit Panel -->
            <materialDesign:Card Grid.Column="2" Padding="12">
                <Grid>
                    <!-- View Mode (when not editing and account selected) -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ScrollViewer.Style>
                            <Style TargetType="ScrollViewer">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsEditing}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedAccount}" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ScrollViewer.Style>
                        <StackPanel>
                            <TextBlock Text="帳號詳情"
                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                       Margin="0,0,0,16"/>

                            <TextBlock Text="顯示名稱"
                                       Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                       Foreground="Gray"/>
                            <TextBlock Text="{Binding SelectedAccount.DisplayName}"
                                       FontSize="14"
                                       Margin="0,0,0,12"/>

                            <TextBlock Text="Email/帳號"
                                       Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                       Foreground="Gray"/>
                            <TextBlock Text="{Binding SelectedAccount.Username}"
                                       FontSize="14"
                                       Margin="0,0,0,12"/>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <materialDesign:PackIcon Kind="Key"
                                                         VerticalAlignment="Center"
                                                         Margin="0,0,4,0">
                                    <materialDesign:PackIcon.Style>
                                        <Style TargetType="materialDesign:PackIcon">
                                            <Setter Property="Foreground" Value="Green"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedAccount.RememberPassword}" Value="False">
                                                    <Setter Property="Foreground" Value="Gray"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </materialDesign:PackIcon.Style>
                                </materialDesign:PackIcon>
                                <TextBlock FontSize="12" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="Green"/>
                                            <Setter Property="Text" Value="密碼已儲存"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedAccount.RememberPassword}" Value="False">
                                                    <Setter Property="Foreground" Value="Gray"/>
                                                    <Setter Property="Text" Value="密碼未儲存"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                <materialDesign:PackIcon Kind="TwoFactorAuthentication"
                                                         VerticalAlignment="Center"
                                                         Margin="0,0,4,0">
                                    <materialDesign:PackIcon.Style>
                                        <Style TargetType="materialDesign:PackIcon">
                                            <Setter Property="Foreground" Value="Green"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasOtpConfigured}" Value="False">
                                                    <Setter Property="Foreground" Value="Gray"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </materialDesign:PackIcon.Style>
                                </materialDesign:PackIcon>
                                <TextBlock FontSize="12" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="OTP 已設定"/>
                                            <Setter Property="Foreground" Value="Green"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasOtpConfigured}" Value="False">
                                                    <Setter Property="Foreground" Value="Gray"/>
                                                    <Setter Property="Text" Value="OTP 未設定"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>

                            <!-- Current OTP Code Display -->
                            <Border Background="{DynamicResource MaterialDesignCardBackground}"
                                    CornerRadius="4"
                                    Padding="12"
                                    Margin="0,8,0,16"
                                    Visibility="{Binding HasOtpConfigured, Converter={StaticResource BoolToVisibility}}">
                                <StackPanel>
                                    <TextBlock Text="目前 OTP 驗證碼"
                                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                               Foreground="Gray"/>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding CurrentOtpCode}"
                                                   FontSize="24"
                                                   FontWeight="Bold"
                                                   FontFamily="Consolas"
                                                   Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                        <TextBlock Text="{Binding OtpSecondsRemaining, StringFormat=({0}s)}"
                                                   FontSize="12"
                                                   Foreground="Gray"
                                                   VerticalAlignment="Center"
                                                   Margin="8,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Action Buttons -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,8">
                                <Button Content="編輯"
                                        Command="{Binding EditAccountCommand}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Margin="0,0,8,0"/>
                                <Button Content="刪除"
                                        Command="{Binding DeleteAccountCommand}"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"
                                        Foreground="Red"
                                        BorderBrush="Red"/>
                            </StackPanel>

                            <Button Content="設為預設"
                                    Command="{Binding SetAsDefaultCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="0,4,0,0"/>

                            <Button Content="清除 OTP 秘鑰"
                                    Command="{Binding ClearOtpSecretCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Foreground="Orange"
                                    Visibility="{Binding HasOtpConfigured, Converter={StaticResource BoolToVisibility}}"
                                    Margin="0,4,0,0"/>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Edit Mode -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto"
                                  Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibility}}">
                        <StackPanel>
                            <TextBlock Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                       Margin="0,0,0,16">
                                <TextBlock.Text>
                                    <Binding Path="IsAddingNew">
                                        <Binding.Converter>
                                            <local:BoolToStringConverter xmlns:local="clr-namespace:FFXIVSimpleLauncher.Converters"
                                                                         TrueValue="新增帳號"
                                                                         FalseValue="編輯帳號"/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Text>
                            </TextBlock>

                            <TextBox materialDesign:HintAssist.Hint="顯示名稱"
                                     Text="{Binding EditDisplayName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     Margin="0,0,0,12"/>

                            <TextBox materialDesign:HintAssist.Hint="Email/帳號 *"
                                     Text="{Binding EditUsername, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     Margin="0,0,0,12"/>

                            <PasswordBox materialDesign:HintAssist.Hint="密碼"
                                         x:Name="PasswordBox"
                                         Style="{StaticResource MaterialDesignOutlinedPasswordBox}"
                                         Margin="0,0,0,8"/>

                            <CheckBox Content="記住密碼"
                                      IsChecked="{Binding EditRememberPassword}"
                                      Margin="0,0,0,16"/>

                            <Separator Margin="0,0,0,16"/>

                            <TextBlock Text="OTP 設定"
                                       Style="{StaticResource MaterialDesignSubtitle2TextBlock}"
                                       Margin="0,0,0,8"/>

                            <CheckBox Content="啟用自動 OTP"
                                      IsChecked="{Binding EditAutoOtp}"
                                      Margin="0,0,0,8"/>

                            <TextBox materialDesign:HintAssist.Hint="OTP 秘鑰 (Base32)"
                                     Text="{Binding EditOtpSecret, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     FontFamily="Consolas"
                                     Margin="0,0,0,8"/>

                            <TextBlock Text="輸入新秘鑰以更新，留空則保留現有設定。"
                                       Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                       Foreground="Gray"
                                       TextWrapping="Wrap"
                                       Margin="0,0,0,16"/>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <Button Content="儲存"
                                        Command="{Binding SaveAccountCommand}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Margin="0,0,8,0"
                                        Click="SaveButton_Click"/>
                                <Button Content="取消"
                                        Command="{Binding CancelEditCommand}"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- No Account Selected -->
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding SelectedAccount}" Value="{x:Null}"/>
                                            <Condition Binding="{Binding IsEditing}" Value="False"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>

                        <materialDesign:PackIcon Kind="AccountQuestion"
                                                 Width="48" Height="48"
                                                 Foreground="Gray"
                                                 HorizontalAlignment="Center"/>
                        <TextBlock Text="選擇帳號或新增一個"
                                   Foreground="Gray"
                                   TextAlignment="Center"
                                   Margin="0,8,0,0"/>
                    </StackPanel>
                </Grid>
            </materialDesign:Card>
        </Grid>

        <!-- Footer -->
        <Button Grid.Row="2"
                Content="關閉"
                Click="CloseButton_Click"
                Style="{StaticResource MaterialDesignOutlinedButton}"
                HorizontalAlignment="Right"
                Margin="0,16,0,0"
                Width="100"/>
    </Grid>
</Window>
