<Window x:Class="FFXIVSimpleLauncher.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:viewmodels="clr-namespace:FFXIVSimpleLauncher.ViewModels"
        mc:Ignorable="d"
        Title="XIV TC Launcher"
        Height="520" Width="500"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResizeWithGrip"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Medium"
        FontFamily="{materialDesign:MaterialDesignFont}">

    <Window.DataContext>
        <viewmodels:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Row 0: 啟動器更新提示 -->
            <RowDefinition Height="Auto"/>  <!-- Row 1: Title -->
            <RowDefinition Height="Auto"/>  <!-- Row 2: Subtitle -->
            <RowDefinition Height="Auto"/>  <!-- Row 3: Account Selection -->
            <RowDefinition Height="Auto"/>  <!-- Row 4: Buttons -->
            <RowDefinition Height="Auto"/>  <!-- Row 5: Game Update Card -->
            <RowDefinition Height="*"/>     <!-- Row 6: Status Log -->
        </Grid.RowDefinitions>

        <!-- 啟動器更新提示橫幅 (Row 0) -->
        <materialDesign:Card Grid.Row="0"
                             Margin="0,0,0,16"
                             Padding="12"
                             Background="{DynamicResource PrimaryHueMidBrush}"
                             Visibility="{Binding HasLauncherUpdate, Converter={StaticResource BoolToVisibility}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 正常提示 (未下載時) -->
                <Grid Grid.Row="0">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsDownloadingLauncherUpdate}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                        <TextBlock Foreground="White" FontWeight="Bold" FontSize="14">
                            <Run Text="發現新版本 "/>
                            <Run Text="{Binding LatestLauncherVersion, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="立即更新"
                                Command="{Binding UpdateLauncherCommand}"
                                Margin="0,0,8,0"
                                Padding="12,4"
                                FontSize="12">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatLightBgButton}">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}"/>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Content="查看"
                                Command="{Binding OpenReleasesPageCommand}"
                                Margin="0,0,8,0"
                                Padding="8,4"
                                FontSize="12"
                                Style="{StaticResource MaterialDesignFlatButton}"
                                Foreground="White"/>
                        <Button Content="稍後"
                                Command="{Binding DismissLauncherUpdateCommand}"
                                Padding="8,4"
                                FontSize="12"
                                Style="{StaticResource MaterialDesignFlatButton}"
                                Foreground="White"/>
                    </StackPanel>
                </Grid>

                <!-- 下載中提示 -->
                <StackPanel Grid.Row="1"
                            Visibility="{Binding IsDownloadingLauncherUpdate, Converter={StaticResource BoolToVisibility}}">
                    <TextBlock Text="正在下載更新..."
                               Foreground="White"
                               FontWeight="Bold"
                               FontSize="14"
                               Margin="0,0,0,8"/>
                    <ProgressBar Value="{Binding LauncherUpdateProgress}"
                                 Height="6"
                                 Margin="0,0,0,4"
                                 Foreground="White"
                                 Background="#40FFFFFF"/>
                    <TextBlock Text="{Binding LauncherDownloadInfo}"
                               Foreground="#CCFFFFFF"
                               FontSize="11"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Title -->
        <TextBlock Grid.Row="1"
                   Text="XIV TC Launcher"
                   Style="{StaticResource MaterialDesignHeadline5TextBlock}"
                   HorizontalAlignment="Center"
                   Margin="0,0,0,8"/>

        <!-- Subtitle with Version -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,16">
            <TextBlock Text="台灣版"
                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                       Foreground="{DynamicResource MaterialDesignBodyLight}"/>
            <TextBlock Text=" - "
                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                       Foreground="{DynamicResource MaterialDesignBodyLight}"/>
            <TextBlock Text="{Binding AppVersion}"
                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                       Foreground="{DynamicResource MaterialDesignBodyLight}"/>
        </StackPanel>

        <!-- Account Selection (Row 3) -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,16">
            <TextBlock Text="帳號："
                       VerticalAlignment="Center"
                       Margin="0,0,8,0"
                       Foreground="{DynamicResource MaterialDesignBodyLight}"/>
            <ComboBox Width="200"
                      ItemsSource="{Binding Accounts}"
                      SelectedItem="{Binding SelectedAccount}"
                      Style="{StaticResource MaterialDesignOutlinedComboBox}"
                      materialDesign:HintAssist.Hint="選擇帳號">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding DisplayName}"/>
                            <TextBlock Text=" - "
                                       Foreground="Gray"
                                       FontSize="11"/>
                            <TextBlock Text="{Binding Username}"
                                       Foreground="Gray"
                                       FontSize="11"/>
                        </StackPanel>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
            <Button Style="{StaticResource MaterialDesignIconButton}"
                    Command="{Binding OpenAccountManagerCommand}"
                    ToolTip="管理帳號"
                    Margin="4,0,0,0">
                <materialDesign:PackIcon Kind="AccountCog"/>
            </Button>
        </StackPanel>

        <!-- No Accounts Message -->
        <TextBlock Grid.Row="3"
                   Text="尚未設定帳號，請點擊右側按鈕新增"
                   Foreground="Orange"
                   FontSize="12"
                   HorizontalAlignment="Center"
                   Margin="0,8,0,16">
            <TextBlock.Style>
                <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasAccounts}" Value="False">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </TextBlock.Style>
        </TextBlock>

        <!-- Buttons (Row 4) -->
        <StackPanel Grid.Row="4" Orientation="Vertical" HorizontalAlignment="Center">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="登入"
                        Command="{Binding LoginCommand}"
                        IsEnabled="{Binding CanLogin}"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        Width="140"
                        Height="40"
                        FontSize="16"
                        Margin="0,0,16,0"/>

                <Button Content="設定"
                        Command="{Binding OpenSettingsCommand}"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Width="140"
                        Height="40"
                        FontSize="16"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,12,0,0">
                <Button Content="測試注入 (跳過登入)"
                        Command="{Binding TestInjectCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Foreground="Orange"
                        Height="32"
                        FontSize="12"
                        ToolTip="以假的 Session 啟動遊戲來測試 Dalamud 注入 (會在大廳斷線)"/>

                <Button Content="手動注入 Dalamud"
                        Command="{Binding ManualInjectCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Foreground="#AB47BC"
                        Height="32"
                        FontSize="12"
                        Margin="8,0,0,0"
                        ToolTip="注入 Dalamud 到已運行的遊戲進程"
                        Visibility="{Binding EnableDalamud, Converter={StaticResource BoolToVisibility}}"/>
            </StackPanel>
        </StackPanel>

        <!-- Update Card (顯示當有更新時或更新中) -->
        <materialDesign:Card Grid.Row="5"
                             Margin="0,16,0,0"
                             Padding="16"
                             Background="{DynamicResource MaterialDesignCardBackground}">
            <materialDesign:Card.Style>
                <Style TargetType="materialDesign:Card">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUpdate}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding IsUpdating}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding IsCheckingUpdate}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </materialDesign:Card.Style>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 標題 -->
                <TextBlock Grid.Row="0"
                           Text="遊戲更新"
                           Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                           Margin="0,0,0,12"/>

                <!-- 更新資訊 -->
                <TextBlock Grid.Row="1"
                           Text="{Binding UpdateInfo}"
                           FontSize="13"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           Margin="0,0,0,12">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding UpdateInfo}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- 檢查中提示 -->
                <StackPanel Grid.Row="1"
                            Orientation="Horizontal"
                            Visibility="{Binding IsCheckingUpdate, Converter={StaticResource BoolToVisibility}}"
                            Margin="0,0,0,12">
                    <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                 IsIndeterminate="True"
                                 Width="20"
                                 Height="20"
                                 Margin="0,0,8,0"/>
                    <TextBlock Text="檢查更新中..."
                               VerticalAlignment="Center"
                               FontSize="13"
                               Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                </StackPanel>

                <!-- 進度條 -->
                <ProgressBar Grid.Row="2"
                             Value="{Binding UpdateProgress}"
                             Height="8"
                             Margin="0,0,0,8"
                             Visibility="{Binding IsUpdating, Converter={StaticResource BoolToVisibility}}"/>

                <!-- 詳細資訊 -->
                <StackPanel Grid.Row="3"
                            Orientation="Horizontal"
                            Visibility="{Binding IsUpdating, Converter={StaticResource BoolToVisibility}}"
                            Margin="0,0,0,12">
                    <TextBlock Text="{Binding DownloadSpeed}"
                               FontSize="11"
                               Foreground="Gray"/>
                    <TextBlock Text=" | "
                               FontSize="11"
                               Foreground="Gray"
                               Visibility="{Binding IsUpdating, Converter={StaticResource BoolToVisibility}}"/>
                    <TextBlock Text="{Binding RemainingTime}"
                               FontSize="11"
                               Foreground="Gray"/>
                    <TextBlock Text=" | "
                               FontSize="11"
                               Foreground="Gray"
                               Visibility="{Binding IsUpdating, Converter={StaticResource BoolToVisibility}}"/>
                    <TextBlock Text="{Binding UpdateProgress, StringFormat={}{0:F1}%}"
                               FontSize="11"
                               Foreground="Gray"/>
                </StackPanel>

                <!-- 按鈕 -->
                <StackPanel Grid.Row="4"
                            Orientation="Horizontal"
                            HorizontalAlignment="Left">
                    <!-- 開始更新按鈕 -->
                    <Button Content="開始更新"
                            Command="{Binding StartUpdateCommand}"
                            Width="100"
                            Height="32"
                            FontSize="13"
                            Margin="0,0,12,0">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsUpdating}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsCheckingUpdate}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding HasUpdate}" Value="False">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- 取消更新按鈕 -->
                    <Button Content="取消"
                            Command="{Binding CancelUpdateCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Width="80"
                            Height="32"
                            FontSize="13"
                            Visibility="{Binding IsUpdating, Converter={StaticResource BoolToVisibility}}"/>

                    <!-- 重新檢查按鈕 -->
                    <Button Content="重新檢查"
                            Command="{Binding CheckForUpdatesCommand}"
                            Height="32"
                            FontSize="12"
                            Foreground="{DynamicResource PrimaryHueMidBrush}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding HasUpdate}" Value="False"/>
                                            <Condition Binding="{Binding IsUpdating}" Value="False"/>
                                            <Condition Binding="{Binding IsCheckingUpdate}" Value="False"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Status Message with Scroll -->
        <materialDesign:Card Grid.Row="6"
                             Margin="0,16,0,0"
                             Padding="12"
                             Background="{DynamicResource MaterialDesignCardBackground}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <TextBlock Grid.Row="0"
                           Text="狀態日誌"
                           Style="{StaticResource MaterialDesignCaptionTextBlock}"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           Margin="0,0,0,8"/>
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              MaxHeight="100">
                    <TextBlock Text="{Binding StatusMessage}"
                               TextWrapping="Wrap"
                               FontFamily="Consolas"
                               FontSize="11"
                               Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                </ScrollViewer>
            </Grid>
        </materialDesign:Card>
    </Grid>
</Window>
